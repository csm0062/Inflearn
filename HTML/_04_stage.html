<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag Events Example</title>
    <link rel="stylesheet" href="../css/_01_the_hostel.css">
    <style>
        /* 아이템 존을 중앙 위쪽에 배치하는 컨테이너 */
        .itemzone-container {
            position: absolute;
            top: 20px;  /* 화면 위에서 20px 아래에 배치 */
            margin: auto;
            width: 100%;
            display: flex;
            justify-content: center;
            opacity: 100%;
            padding: 20px;  /* 패딩 20px */
            box-sizing: border-box;  /* 패딩 포함한 너비 계산 */
        }

        /* 드래그 가능한 요소 스타일 */
        .draggable {
            width: 100px;  /* 요소 너비 */
            height: 100px;  /* 요소 높이 */
            text-align: center;  /* 텍스트 중앙 정렬 */
            line-height: 100px;  /* 텍스트 수직 정렬 */
            cursor: grab;  /* 커서 모양 변경 */
            position: relative !important;
            transform: none !important;
            top: 0 !important;
            left: 0 !important;
            border: 1px solid black;
        }

        /* 드롭 가능한 영역을 화면 중앙에 배치하는 컨테이너 */
        .dropzone-container {
            position: absolute;
            top: 50%;  /* 화면의 50% 지점에 배치 */
            left: 50%;  /* 화면의 50% 지점에 배치 */
            transform: translate(-50%, -50%);  /* 정확히 중앙에 배치되도록 조정 */
            display: flex;
            justify-content: center;
            box-sizing: border-box;  /* 패딩 포함한 너비 계산 */
            width: 700px;  /* 고정 너비 */
        }

        /* 드롭 가능한 영역 스타일 */
        .dropzone {
            width: 100px;  /* 영역 너비 */
            height: 100px;  /* 영역 높이 */
            background-color: none;  /* 배경 색상 */
            text-align: center;  /* 텍스트 중앙 정렬 */
            line-height: 200px;  /* 텍스트 수직 정렬 */
            margin: 10px;  /* 외부 여백 */
            border: 2px dashed #aaa;  /* 점선 테두리 */
            position: relative;  /* 상대적 위치 설정 */
            display: flex;
            justify-content: center;
            align-items: center;
            background-size: cover;
        }

        /* 숨기기 위한 클래스 */
        .hidden {
            display: none;
        }

        /* 편지봉투 이미지를 중앙에 배치하는 스타일 */
        #envelope-image {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;  /* 맨 위에 배치 */
            display: none;  /* 초기에는 숨김 */
        }
    </style>
</head>
<body>
  <div id="overlay-top"></div>
    <div id="game-container">
        <img id="stage-image" src="../image/images/stage/무대배경.JPG" alt="Stage" style="width: 100%; height: 100%;">
        <button id="left-button" class="nav-button" onclick="location.href='_03_right_wall.html'">&lt;</button>
        <button id="right-button" class="nav-button" onclick="location.href='_05_left_wall.html'">&gt;</button>

        <div class="itemzone-container" id="item-zone">
            <!-- 드래그 가능한 아이템들 -->
            <div id="draggable1" class="draggable" draggable="true" data-id="1">Item 1</div>
            <div id="draggable2" class="draggable" draggable="true" data-id="2">Item 2</div>
            <div id="draggable3" class="draggable" draggable="true" data-id="3">Item 3</div>
            <div id="draggable4" class="draggable" draggable="true" data-id="4">Item 4</div>
        </div>

        <div class="dropzone-container" id="dropzone-container">
            <!-- 드롭 가능한 영역들 -->
            <div id="dropzone1" class="dropzone" data-id="4"></div>
            <div id="dropzone2" class="dropzone" data-id="3"></div>
            <div id="dropzone3" class="dropzone" data-id="1"></div>
            <div id="dropzone4" class="dropzone" data-id="2"></div>
        </div>

        <!-- 아이템 버튼 추가 -->
        <button type="button" class="btn btn-primary-item" id="button-item" onclick="goToInventory()">💼</button>
    </div>
    <div id="overlay-bottom"></div>
    <div class="shadow-overlay"></div>

    <!-- 편지봉투 이미지 -->
    <img id="envelope-image" src="../image/images/stage/열리편지봉투.PNG" alt="Envelope" />

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const draggables = document.querySelectorAll('.draggable');
            const dropzones = document.querySelectorAll('.dropzone');
            const itemZone = document.getElementById('item-zone');
            const stageImage = document.getElementById('stage-image');
            const envelopeImage = document.getElementById('envelope-image');
            let droppedItems = 0;

            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('text/plain', event.target.dataset.id);
                    event.dataTransfer.effectAllowed = 'move';  // 드래그 효과 설정
                });
            });

            dropzones.forEach(dropzone => {
                dropzone.addEventListener('dragover', (event) => {
                    event.preventDefault();  // 기본 동작 방지
                    event.dataTransfer.dropEffect = 'move';  // 드롭 효과 설정
                });

                dropzone.addEventListener('drop', (event) => {
                    event.preventDefault();  // 기본 동작 방지
                    const draggedId = event.dataTransfer.getData('text/plain');
                    const dropzoneId = event.target.dataset.id;

                    if (draggedId === dropzoneId) {
                        const draggedElement = document.querySelector(`[data-id='${draggedId}']`);
                        dropzone.appendChild(draggedElement);
                        draggedElement.style.position = 'absolute';
                        draggedElement.style.top = '50%';
                        draggedElement.style.left = '50%';
                        draggedElement.style.transform = 'translate(-50%, -50%)';
                        droppedItems++;
                        checkAllItemsDropped();
                    } else {
                        alert('여기가 아닌 것 같다...');
                    }
                });
            });

            itemZone.addEventListener('dragover', (event) => {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
            });

            itemZone.addEventListener('drop', (event) => {
                event.preventDefault();
                const draggedId = event.dataTransfer.getData('text/plain');
                const draggedElement = document.querySelector(`[data-id='${draggedId}']`);
                itemZone.appendChild(draggedElement);
                draggedElement.style.position = 'relative';
                draggedElement.style.top = 'auto';
                draggedElement.style.left = 'auto';
                draggedElement.style.transform = 'none';
            });

            const inventory = JSON.parse(localStorage.getItem("inventory"));
            let idx = 1;

            inventory.forEach((ele) => {
                if(ele.includes("심장") || ele.includes("반지") || ele.includes("깨진액자") || ele.includes("쟁미")) {
                    document.querySelector(`#draggable${idx}`).textContent = '';
                    document.querySelector(`#draggable${idx}`).style.background = `url(${ele})`;
                    document.querySelector(`#draggable${idx}`).style.backgroundColor = `white`;
                    document.querySelector(`#draggable${idx}`).style.backgroundSize = 'contain';
                    document.querySelector(`#draggable${idx}`).style.backgroundRepeat = 'no-repeat';
                    document.querySelector(`#draggable${idx}`).style.backgroundPosition = 'center center';
                    idx++;
                }
            });

            function checkAllItemsDropped() {
                if (droppedItems === 4) {
                    // 모든 아이템이 드롭존에 올바르게 배치된 경우
                    stageImage.classList.add('hidden'); // 무대 이미지 숨기기
                    itemZone.classList.add('hidden'); // 아이템 존 숨기기
                    dropzones.forEach(dropzone => dropzone.classList.add('hidden')); // 드롭존 숨기기
                    envelopeImage.style.display = 'block'; // 편지봉투 이미지 보이기

                    // 중복 방지를 위해 희귀 동전 추가 전에 인벤토리 확인
                    let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
                    if (!inventory.includes('../image/images/useritem/동전.png')) {
                        setTimeout(() => {
                            alert('희귀 동전을 얻었다.');
                            inventory.push('../image/images/useritem/동전.png');
                            localStorage.setItem('inventory', JSON.stringify(inventory));
                            location.href = '_05_left_wall.html';
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            alert('희귀 동전이 이미 인벤토리에 있습니다.');
                            location.href = '_05_left_wall.html';
                        }, 2000);
                    }
                }
            }
        });

        function goToInventory() {
            window.location.href = "../HTML/inventory.html";
        }
    </script>
    <!-- <script src="inventory.js"></script> -->
</body>
</html>
